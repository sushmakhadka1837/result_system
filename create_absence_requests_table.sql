CREATE TABLE IF NOT EXISTS student_absence_requests (
    id INT AUTO_INCREMENT PRIMARY KEY,
    student_id INT NOT NULL,
    request_scope ENUM('class', 'exam') NOT NULL DEFAULT 'exam',
    subject_id INT NULL,
    request_type ENUM('Medical', 'Family Emergency', 'Official', 'Other') NOT NULL,
    exam_component ENUM('UT', 'Assessment', 'Final', 'Practical', 'Other') NULL DEFAULT NULL,
    absence_date DATE NOT NULL,
    reason_text TEXT NOT NULL,
    proof_file VARCHAR(255) NOT NULL,
    status ENUM('pending', 'approved', 'rejected', 'need_info') NOT NULL DEFAULT 'pending',
    teacher_remark TEXT NULL,
    reviewed_by INT NULL,
    reviewed_at DATETIME NULL,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_student_status (student_id, status),
    INDEX idx_subject_exam (subject_id, exam_component),
    INDEX idx_scope_status (request_scope, status),
    INDEX idx_status_created (status, created_at),
    CONSTRAINT fk_absence_student FOREIGN KEY (student_id) REFERENCES students(id) ON DELETE CASCADE,
    CONSTRAINT fk_absence_subject FOREIGN KEY (subject_id) REFERENCES subjects_master(id) ON DELETE RESTRICT,
    CONSTRAINT fk_absence_teacher FOREIGN KEY (reviewed_by) REFERENCES teachers(id) ON DELETE SET NULL
);
